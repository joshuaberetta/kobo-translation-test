name: Bulk Retranslate Documentation

on:
  workflow_dispatch:
    inputs:
      languages:
        description: 'Target language(s) - comma-separated (es, fr, ar)'
        required: true
        default: 'es'
        type: string
      
      files:
        description: 'Files to retranslate (comma-separated filenames, e.g., about_kobotoolbox.md,quick_start.md). Leave empty for ALL files.'
        required: false
        type: string
      
      mode:
        description: 'Translation mode'
        required: true
        type: choice
        default: 'test'
        options:
          - test       # 2-3 test files only
          - specific   # Specific files listed above
          - all        # ALL files (expensive!)
      
      skill_version:
        description: 'Skill version to use'
        required: true
        type: choice
        default: 'v1'
        options:
          - v1         # Current production skills (kobo-translation-{lang})
          - v2         # New v2 skills (kobo-translation-v2-{lang})
          - both       # Test both versions side-by-side
      
      confirm_cost:
        description: 'âš ï¸ I understand the cost implications (required for "all" mode)'
        required: false
        type: boolean
        default: false

jobs:
  bulk-retranslate:
    name: Bulk Retranslate (${{ github.event.inputs.mode }})
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Validate inputs
        run: |
          echo "=== Bulk Retranslation Workflow ==="
          echo "Mode: ${{ github.event.inputs.mode }}"
          echo "Skill version: ${{ github.event.inputs.skill_version }}"
          echo "Languages: ${{ github.event.inputs.languages }}"
          echo "Files: ${{ github.event.inputs.files || '(ALL)' }}"
          echo "Cost confirmed: ${{ github.event.inputs.confirm_cost }}"
          
          # Validate mode=all requires confirmation
          if [ "${{ github.event.inputs.mode }}" == "all" ] && [ "${{ github.event.inputs.confirm_cost }}" != "true" ]; then
            echo "âŒ ERROR: Mode 'all' requires cost confirmation"
            echo ""
            echo "Retranslating ALL files can cost \$15-30 per language."
            echo "Please check the 'I understand the cost implications' checkbox to proceed."
            exit 1
          fi
          
          # Adjust cost for 'both' skill version (double the cost)
          if [ "${{ github.event.inputs.skill_version }}" == "both" ] && [ "${{ github.event.inputs.mode }}" == "all" ]; then
            echo "âš ï¸  WARNING: 'both' mode will translate with BOTH v1 and v2 skills"
            echo "This will double the cost: \$30-60 per language"
          fi
          
          echo "âœ… Validation passed"
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install -r scripts/requirements.txt
      
      - name: Verify skill files
        run: |
          echo "ðŸ“š Checking for skill files..."
          SKILL_VERSION="${{ github.event.inputs.skill_version }}"
          
          # Function to check skills
          check_skills() {
            local VERSION=$1
            local SUFFIX=$2
            echo ""
            echo "=== Checking $VERSION skills ==="
            
            SKILLS_FOUND=0
            for LANG in $(echo "${{ github.event.inputs.languages }}" | tr ',' ' '); do
              SKILL_DIR="skills/kobo-translation${SUFFIX}-${LANG}"
              if [ -d "$SKILL_DIR" ] && [ -f "$SKILL_DIR/SKILL.md" ]; then
                echo "âœ… $VERSION skill found for ${LANG}: $SKILL_DIR"
                SKILLS_FOUND=$((SKILLS_FOUND + 1))
              else
                echo "âš ï¸  $VERSION skill not found for ${LANG}: $SKILL_DIR"
              fi
            done
            
            # Check generic skill (fallback)
            GENERIC_SKILL="skills/kobo-translation${SUFFIX}"
            if [ -d "$GENERIC_SKILL" ] && [ -f "$GENERIC_SKILL/SKILL.md" ]; then
              echo "âœ… $VERSION generic skill found: $GENERIC_SKILL"
            else
              echo "âš ï¸  $VERSION generic skill not found: $GENERIC_SKILL"
            fi
            
            if [ $SKILLS_FOUND -eq 0 ] && [ ! -f "$GENERIC_SKILL/SKILL.md" ]; then
              echo "âŒ Error: No $VERSION skills found"
              return 1
            fi
            
            echo "âœ… $VERSION verification complete ($SKILLS_FOUND language-specific skills found)"
            return 0
          }
          
          # Check based on skill_version input
          if [ "$SKILL_VERSION" == "v1" ]; then
            check_skills "v1" "" || exit 1
            
          elif [ "$SKILL_VERSION" == "v2" ]; then
            check_skills "v2" "-v2" || exit 1
            
          elif [ "$SKILL_VERSION" == "both" ]; then
            V1_OK=true
            V2_OK=true
            
            check_skills "v1" "" || V1_OK=false
            check_skills "v2" "-v2" || V2_OK=false
            
            if [ "$V1_OK" == "false" ] || [ "$V2_OK" == "false" ]; then
              echo ""
              echo "âŒ Error: 'both' mode requires both v1 and v2 skills to exist"
              exit 1
            fi
            
            echo ""
            echo "âœ… Both v1 and v2 skills verified"
          else
            echo "âŒ Error: Unknown skill_version: $SKILL_VERSION"
            exit 1
          fi
      
      - name: Determine files to translate
        id: files
        run: |
          MODE="${{ github.event.inputs.mode }}"
          FILES_INPUT="${{ github.event.inputs.files }}"
          
          if [ "$MODE" == "test" ]; then
            # Test mode: translate 2-3 test files
            FILES="test_simple.md test_complex.md"
            echo "ðŸ“ Test mode: translating sample files"
            
          elif [ "$MODE" == "specific" ]; then
            # Specific mode: use files from input
            if [ -z "$FILES_INPUT" ]; then
              echo "âŒ Error: Mode 'specific' requires files to be specified"
              exit 1
            fi
            FILES="$FILES_INPUT"
            echo "ðŸ“ Specific mode: translating specified files"
            
          elif [ "$MODE" == "all" ]; then
            # All mode: find all markdown files
            echo "ðŸ“ All mode: finding all markdown files in docs/en/"
            ALL_FILES=$(find docs/en -name "*.md" -type f -exec basename {} \; | tr '\n' ' ')
            FILES="$ALL_FILES"
            
            FILE_COUNT=$(echo "$FILES" | wc -w)
            echo "ðŸ“Š Found $FILE_COUNT files to translate"
            
          else
            echo "âŒ Error: Unknown mode: $MODE"
            exit 1
          fi
          
          # Clean up files list (remove extra spaces, newlines)
          FILES=$(echo "$FILES" | tr ',' ' ' | xargs)
          
          # Save to output
          echo "files=$FILES" >> $GITHUB_OUTPUT
          
          echo ""
          echo "=== Files to translate ==="
          echo "$FILES" | tr ' ' '\n'
          echo "=========================="
      
      - name: Setup skill symlinks (for v2)
        if: github.event.inputs.skill_version == 'v2' || github.event.inputs.skill_version == 'both'
        run: |
          echo "ðŸ”— Setting up skill symlinks..."
          
          # For v2 or both mode, we need to make v2 skills available
          # Create symlinks so translation_agent.py can find them
          
          for LANG in $(echo "${{ github.event.inputs.languages }}" | tr ',' ' '); do
            V2_SKILL="skills/kobo-translation-v2-${LANG}"
            
            if [ -d "$V2_SKILL" ]; then
              # For 'v2' mode, create symlink to replace v1
              if [ "${{ github.event.inputs.skill_version }}" == "v2" ]; then
                V1_SKILL="skills/kobo-translation-${LANG}"
                
                # Backup v1 if it exists
                if [ -d "$V1_SKILL" ] && [ ! -L "$V1_SKILL" ]; then
                  echo "ðŸ“¦ Backing up v1 skill: $V1_SKILL â†’ ${V1_SKILL}.v1-backup"
                  mv "$V1_SKILL" "${V1_SKILL}.v1-backup"
                fi
                
                echo "ðŸ”— Symlinking v2 â†’ v1 location: $V2_SKILL â†’ $V1_SKILL"
                ln -sf "kobo-translation-v2-${LANG}" "$V1_SKILL"
              fi
              
              # For 'both' mode, v2 skills stay in place (we'll run twice)
              echo "âœ… v2 skill ready for ${LANG}"
            fi
          done
          
          echo "âœ… Skill setup complete"
      
      - name: Bulk retranslate
        id: retranslate
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "ðŸ”„ Starting bulk retranslation..."
          echo ""
          
          FILES="${{ steps.files.outputs.files }}"
          LANGUAGES="${{ github.event.inputs.languages }}"
          SKILL_VERSION="${{ github.event.inputs.skill_version }}"
          
          # Build language arguments (space-separated for single --language flag)
          LANG_ARGS="--language"
          for LANG in $(echo "$LANGUAGES" | tr ',' ' '); do
            LANG_ARGS="$LANG_ARGS $LANG"
          done
          
          # Build file arguments (space-separated for single --files flag)
          FILE_ARGS="--files"
          for FILE in $FILES; do
            FILE_ARGS="$FILE_ARGS $FILE"
          done
          
          SUCCESS="true"
          
          # Function to run translation
          run_translation() {
            local VERSION_LABEL=$1
            local OUTPUT_SUFFIX=$2
            
            echo ""
            echo "=========================================="
            echo "ðŸ”„ Translating with $VERSION_LABEL skills"
            echo "=========================================="
            
            # For v2 in 'both' mode, temporarily symlink v2 skills
            if [ "$SKILL_VERSION" == "both" ] && [ "$VERSION_LABEL" == "v2" ]; then
              echo "ðŸ”— Temporarily activating v2 skills..."
              for LANG in $(echo "$LANGUAGES" | tr ',' ' '); do
                V1_SKILL="skills/kobo-translation-${LANG}"
                V2_SKILL="skills/kobo-translation-v2-${LANG}"
                
                if [ -d "$V2_SKILL" ]; then
                  if [ -d "$V1_SKILL" ] && [ ! -L "$V1_SKILL" ]; then
                    mv "$V1_SKILL" "${V1_SKILL}.v1-temp"
                  fi
                  ln -sf "kobo-translation-v2-${LANG}" "$V1_SKILL"
                fi
              done
            fi
            
            echo "Command: python scripts/bulk_retranslate.py $LANG_ARGS $FILE_ARGS --verbose"
            echo ""
            
            if python scripts/bulk_retranslate.py $LANG_ARGS $FILE_ARGS --verbose; then
              echo "âœ… Translation with $VERSION_LABEL completed successfully"
              
              # For 'both' mode, move outputs to versioned directories
              if [ "$SKILL_VERSION" == "both" ]; then
                echo "ðŸ“¦ Moving outputs to ${OUTPUT_SUFFIX} directories..."
                for LANG in $(echo "$LANGUAGES" | tr ',' ' '); do
                  TARGET_DIR="docs/${LANG}${OUTPUT_SUFFIX}"
                  mkdir -p "$TARGET_DIR"
                  
                  # Move translated files
                  for FILE in $FILES; do
                    if [ -f "docs/${LANG}/${FILE}" ]; then
                      mv "docs/${LANG}/${FILE}" "$TARGET_DIR/"
                      echo "  â†’ docs/${LANG}/${FILE} â†’ $TARGET_DIR/"
                    fi
                  done
                done
              fi
              
            else
              echo "âŒ Translation with $VERSION_LABEL failed"
              return 1
            fi
            
            # Restore v1 skills if we symlinked v2
            if [ "$SKILL_VERSION" == "both" ] && [ "$VERSION_LABEL" == "v2" ]; then
              echo "ðŸ”— Restoring v1 skills..."
              for LANG in $(echo "$LANGUAGES" | tr ',' ' '); do
                V1_SKILL="skills/kobo-translation-${LANG}"
                
                if [ -L "$V1_SKILL" ]; then
                  rm "$V1_SKILL"
                fi
                
                if [ -d "${V1_SKILL}.v1-temp" ]; then
                  mv "${V1_SKILL}.v1-temp" "$V1_SKILL"
                fi
              done
            fi
            
            return 0
          }
          
          # Execute based on skill_version
          if [ "$SKILL_VERSION" == "v1" ]; then
            run_translation "v1" "" || SUCCESS="false"
            
          elif [ "$SKILL_VERSION" == "v2" ]; then
            run_translation "v2" "" || SUCCESS="false"
            
          elif [ "$SKILL_VERSION" == "both" ]; then
            echo "ðŸ“Š Running comparison mode: translating with both v1 and v2 skills"
            echo ""
            
            # Translate with v1 first
            run_translation "v1" "-v1" || SUCCESS="false"
            
            # Then translate with v2
            if [ "$SUCCESS" == "true" ]; then
              run_translation "v2" "-v2" || SUCCESS="false"
            fi
            
            # Move v1 outputs back to main location for PR
            if [ "$SUCCESS" == "true" ]; then
              echo ""
              echo "ðŸ“Š Organizing comparison outputs..."
              for LANG in $(echo "$LANGUAGES" | tr ',' ' '); do
                # Create comparison directory structure
                mkdir -p "docs/${LANG}-comparison/v1"
                mkdir -p "docs/${LANG}-comparison/v2"
                
                # Move v1 and v2 outputs to comparison dir
                if [ -d "docs/${LANG}-v1" ]; then
                  mv docs/${LANG}-v1/* "docs/${LANG}-comparison/v1/" 2>/dev/null || true
                  rmdir "docs/${LANG}-v1" 2>/dev/null || true
                fi
                
                if [ -d "docs/${LANG}-v2" ]; then
                  mv docs/${LANG}-v2/* "docs/${LANG}-comparison/v2/" 2>/dev/null || true
                  rmdir "docs/${LANG}-v2" 2>/dev/null || true
                fi
                
                echo "âœ… Created comparison structure: docs/${LANG}-comparison/{v1,v2}/"
              done
            fi
          fi
          
          echo ""
          echo "=========================================="
          if [ "$SUCCESS" == "true" ]; then
            echo "âœ… All translations completed successfully"
          else
            echo "âŒ Translation failed"
          fi
          echo "=========================================="
          
          echo "success=$SUCCESS" >> $GITHUB_OUTPUT
      
      - name: Create Pull Request
        if: steps.retranslate.outputs.success == 'true'
        uses: peter-evans/create-pull-request@v6
        id: pr
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            ðŸ”„ Bulk retranslate: ${{ github.event.inputs.mode }} mode (${{ github.event.inputs.skill_version }})
            
            Skill version: ${{ github.event.inputs.skill_version }}
            Languages: ${{ github.event.inputs.languages }}
            Files: ${{ github.event.inputs.mode == 'all' && 'ALL FILES' || steps.files.outputs.files }}
            
            Triggered by: @${{ github.actor }}
          branch: translations/bulk-retranslate-${{ github.run_number }}
          delete-branch: true
          title: "ðŸ”„ Bulk Retranslation (${{ github.event.inputs.mode }}) - ${{ github.event.inputs.skill_version }} #${{ github.run_number }}"
          body: |
            ## ðŸ”„ Bulk Retranslation
            
            **Mode:** `${{ github.event.inputs.mode }}`
            **Skill Version:** `${{ github.event.inputs.skill_version }}`
            **Languages:** `${{ github.event.inputs.languages }}`
            **Triggered by:** @${{ github.actor }}
            
            ### ðŸ“‹ Purpose
            
            This PR contains **bulk retranslated** documentation files. This is typically done when:
            - âœ… Translation skills have been updated
            - âœ… Testing quality improvements from skill changes
            - âœ… Regenerating translations with updated terminology
            ${{ github.event.inputs.skill_version == 'v2' && '- âœ… Testing new V2 translation skills\n' || '' }}
            ${{ github.event.inputs.skill_version == 'both' && '- ðŸ”¬ Comparing V1 vs V2 skill quality\n' || '' }}
            
            ### ðŸ”„ Translation Mode
            
            **âš¡ FORCE TRANSLATION MODE**
            - All specified files were **fully re-translated** from scratch
            - This ensures latest terminology and style guidelines are applied
            - Existing translations were completely regenerated
            
            ${{ github.event.inputs.mode == 'test' && '**Test Mode:** Only sample files (test_simple.md, test_complex.md) were retranslated for validation.\n' || '' }}
            ${{ github.event.inputs.mode == 'specific' && format('**Specific Mode:** Only the following files were retranslated:\n```\n{0}\n```\n', steps.files.outputs.files) || '' }}
            ${{ github.event.inputs.mode == 'all' && '**âš ï¸ ALL FILES MODE:** The entire documentation corpus was retranslated. This is a major update.\n' || '' }}
            
            ${{ github.event.inputs.skill_version == 'both' && '### ðŸ”¬ V1 vs V2 Comparison\n\nThis PR includes translations from **both** V1 and V2 skills for side-by-side comparison:\n\n- `docs/{lang}-comparison/v1/` - Translations using current V1 skills\n- `docs/{lang}-comparison/v2/` - Translations using new V2 skills\n\n**Review Focus:**\n- Compare translation quality between versions\n- Identify improvements in V2\n- Check for any regressions\n- Validate terminology consistency\n\n**Comparison Commands:**\n```bash\n# Compare specific file between v1 and v2\ndiff docs/es-comparison/v1/about_kobotoolbox.md docs/es-comparison/v2/about_kobotoolbox.md\n\n# View all differences for Spanish\nfor file in docs/es-comparison/v1/*.md; do\n  filename=$(basename "$file")\n  echo "=== $filename ==="\n  diff "$file" "docs/es-comparison/v2/$filename" || true\ndone\n```\n\n' || '' }}
            
            ### ðŸŽ¯ Expected Changes
            
            Since this is a **bulk retranslation**, you may see:
            - âœ… Improved terminology consistency (if skills were updated)
            - âœ… Better style adherence (if guidelines were refined)
            - âš ï¸ Formatting changes (spacing, line breaks)
            - âš ï¸ Rephrased content (even if meaning is identical)
            ${{ github.event.inputs.skill_version == 'v2' && '- ðŸ†• V2-specific improvements (smaller context, focused terminology)\n' || '' }}
            
            ### âœ… Review Checklist
            
            **Before merging, verify:**
            
            **Brand Terms:**
            - [ ] Spanish: "Servidor Global" (NOT "Servidor Global de KoboToolbox")
            - [ ] French: "Le serveur KoboToolbox mondial" (WITH "Le")
            - [ ] Spanish: "La biblioteca de preguntas" (capital L)
            - [ ] French: "La bibliothÃ¨que de questions" (capital L)
            - [ ] Formbuilder: English in parentheses on first reference
            
            **UI Elements:**
            - [ ] Draft â†’ Brouillon (FR) / Borrador (ES) - capitalized
            - [ ] Tabs: FORMULAIRE / FORMULARIO (all caps)
            - [ ] Buttons match UI translations
            
            **Language Quality:**
            - [ ] Spanish: informal "tÃº" + gender-inclusive "los/as"
            - [ ] French: formal "vous" + "utilisatrices et utilisateurs"
            - [ ] Links and formatting preserved
            - [ ] No English artifacts or untranslated content
            
            ${{ github.event.inputs.skill_version == 'v2' && '**V2 Skill Validation:**\n- [ ] Improved terminology consistency (V2 has focused glossaries)\n- [ ] Reduced context preserved translation quality\n- [ ] No regressions compared to V1\n\n' || '' }}
            ${{ github.event.inputs.skill_version == 'both' && '**V1 vs V2 Comparison:**\n- [ ] Review sample files from both versions\n- [ ] Document quality improvements in V2\n- [ ] Note any regressions or issues with V2\n- [ ] Decide which version to promote to production\n\n' || '' }}
            **Skill Changes (if applicable):**
            - [ ] Review key files to confirm skill updates improved quality
            - [ ] Compare a few files with previous versions to validate improvements
            - [ ] Verify no regressions in translation quality
            
            ### ðŸ“Š Comparison Tips
            
            To review skill effectiveness:
            
            ```bash
            # Compare specific file changes
            git diff main...translations/bulk-retranslate-${{ github.run_number }} docs/es/about_kobotoolbox.md
            
            # See all changed files
            git diff --stat main...translations/bulk-retranslate-${{ github.run_number }}
            
            # Review a specific language
            git diff main...translations/bulk-retranslate-${{ github.run_number }} docs/es/
            ${{ github.event.inputs.skill_version == 'both' && '\n# Compare V1 vs V2 for a specific file\ndiff docs/es-comparison/v1/about_kobotoolbox.md docs/es-comparison/v2/about_kobotoolbox.md\n\n# Generate full comparison report\nfor lang in es fr ar; do\n  echo "=== $lang ==="\n  diff -r "docs/${lang}-comparison/v1" "docs/${lang}-comparison/v2" --brief | wc -l\ndone' || '' }}
            ```
            
            ### ðŸ”— Related
            
            - Workflow run: #${{ github.run_number }}
            - Commit: ${{ github.sha }}
            - Documentation: [Bulk Retranslation Guide](../docs/guides/BULK_RETRANSLATION.md)
            ${{ github.event.inputs.skill_version == 'v2' && '- V2 Skills: `skills/kobo-translation-v2-{lang}/`\n' || '' }}
            
            **Reviewers:** @es-reviewer @fr-reviewer @ar-reviewer
          labels: |
            translation
            bulk-retranslation
            ${{ github.event.inputs.skill_version == 'v2' && 'v2-skills' || '' }}
            ${{ github.event.inputs.skill_version == 'both' && 'comparison' || '' }}
            needs-review
      
      - name: Job summary
        if: always()
        run: |
          echo "## ðŸ”„ Bulk Retranslation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.retranslate.outputs.success }}" == "true" ]; then
            echo "âœ… **Retranslation Successful**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            if [ -n "${{ steps.pr.outputs.pull-request-number }}" ]; then
              echo "- PR #${{ steps.pr.outputs.pull-request-number }}" >> $GITHUB_STEP_SUMMARY
              echo "- URL: ${{ steps.pr.outputs.pull-request-url }}" >> $GITHUB_STEP_SUMMARY
            fi
            
            echo "- Mode: ${{ github.event.inputs.mode }}" >> $GITHUB_STEP_SUMMARY
            echo "- Skill version: ${{ github.event.inputs.skill_version }}" >> $GITHUB_STEP_SUMMARY
            echo "- Languages: ${{ github.event.inputs.languages }}" >> $GITHUB_STEP_SUMMARY
            
            if [ "${{ github.event.inputs.skill_version }}" == "both" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### ðŸ”¬ Comparison Mode" >> $GITHUB_STEP_SUMMARY
              echo "Translations generated with both V1 and V2 skills for comparison." >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "Check PR for side-by-side comparison in \`docs/{lang}-comparison/\` directories." >> $GITHUB_STEP_SUMMARY
            fi
            
          else
            echo "âŒ **Retranslation Failed**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Check the logs above for error details." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Files" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.files.outputs.files }}" | tr ' ' '\n' >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
