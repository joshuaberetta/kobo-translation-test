name: Translation Agent (Fixed PR Creation)

# This workflow runs the translation agent and creates a PR with translations
# Fixed: Properly handles branch creation and PR

on:
  repository_dispatch:
    types: [translation-needed]
  
  workflow_dispatch:  # Allow manual trigger
    inputs:
      files_to_translate:
        description: 'Files to translate (comma-separated, e.g., docs/en/test_simple.md,docs/en/test_complex.md)'
        required: false
        default: 'docs/en/test_simple.md'
      languages:
        description: 'Languages to translate to (comma-separated: es,fr,ar)'
        required: false
        default: 'es,fr,ar'

jobs:
  translate:
    name: Translate Documents
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.TRANSLATION_BOT_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install -r scripts/requirements.txt
      
      - name: Verify skill files
        run: |
          echo "ðŸ“š Checking for skill files..."
          if [ ! -d "skills/kobo-translation" ]; then
            echo "âŒ Error: skills/kobo-translation directory not found"
            exit 1
          fi
          
          if [ ! -f "skills/kobo-translation/SKILL.md" ]; then
            echo "âŒ Error: SKILL.md not found"
            exit 1
          fi
          
          echo "âœ… Skill files found"
      
      - name: Parse input files (Manual)
        if: github.event_name == 'workflow_dispatch'
        id: manual_files
        run: |
          FILES="${{ github.event.inputs.files_to_translate }}"
          LANGUAGES="${{ github.event.inputs.languages }}"
          
          echo "files=$FILES" >> $GITHUB_OUTPUT
          echo "languages=$LANGUAGES" >> $GITHUB_OUTPUT
          
          echo "Files to translate: $FILES"
          echo "Target languages: $LANGUAGES"
      
      - name: Parse input files (Auto)
        if: github.event_name == 'repository_dispatch'
        id: auto_files
        run: |
          FILES=$(echo '${{ toJson(github.event.client_payload.changed_files) }}' | jq -r 'join(",")')
          LANGUAGES="es,fr,ar"
          
          echo "files=$FILES" >> $GITHUB_OUTPUT
          echo "languages=$LANGUAGES" >> $GITHUB_OUTPUT
          
          echo "Files to translate: $FILES"
          echo "Target languages: $LANGUAGES"
      
      - name: Set files variable
        id: files
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "files=${{ steps.manual_files.outputs.files }}" >> $GITHUB_OUTPUT
            echo "languages=${{ steps.manual_files.outputs.languages }}" >> $GITHUB_OUTPUT
          else
            echo "files=${{ steps.auto_files.outputs.files }}" >> $GITHUB_OUTPUT
            echo "languages=${{ steps.auto_files.outputs.languages }}" >> $GITHUB_OUTPUT
          fi
      
      - name: Generate branch name
        id: branch
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          BRANCH="translations/auto-$TIMESTAMP"
          
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
          
          echo "Will create branch: $BRANCH"
      
      - name: Translate documents
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.TRANSLATION_BOT_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          echo "ðŸ¤– Starting translation process..."
          
          # Get files and languages
          FILES="${{ steps.files.outputs.files }}"
          LANGUAGES="${{ steps.files.outputs.languages }}"
          
          # Convert comma-separated to arrays
          IFS=',' read -ra FILE_ARRAY <<< "$FILES"
          IFS=',' read -ra LANG_ARRAY <<< "$LANGUAGES"
          
          TOTAL_COST=0
          SUCCESS_COUNT=0
          FAIL_COUNT=0
          
          # Create summary file
          echo "# Translation Summary" > translation_summary.md
          echo "" >> translation_summary.md
          echo "**Timestamp:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> translation_summary.md
          echo "" >> translation_summary.md
          
          # Translate each file to each language
          for FILE in "${FILE_ARRAY[@]}"; do
            # Skip empty entries
            [ -z "$FILE" ] && continue
            
            echo "" >> translation_summary.md
            echo "## ðŸ“„ $(basename $FILE)" >> translation_summary.md
            echo "" >> translation_summary.md
            
            for LANG in "${LANG_ARRAY[@]}"; do
              # Skip empty entries
              [ -z "$LANG" ] && continue
              
              echo "  ðŸ”„ Translating $FILE to $LANG..."
              
              # Run translation
              if python scripts/translation_agent.py \
                --file "$FILE" \
                --language "$LANG" \
                --save \
                --test > "translation_${LANG}_output.txt" 2>&1; then
                
                echo "  âœ… $LANG: Success"
                echo "- âœ… **$LANG**: Translation successful" >> translation_summary.md
                SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
                
                # Extract cost from output if available
                if grep -q "Estimated cost" "translation_${LANG}_output.txt"; then
                  COST=$(grep "Estimated cost" "translation_${LANG}_output.txt" | grep -oP '\$\K[0-9.]+' || echo "0")
                  TOTAL_COST=$(echo "$TOTAL_COST + $COST" | bc)
                  echo "  ðŸ’° Cost: \$$COST"
                fi
                
              else
                echo "  âŒ $LANG: Failed"
                echo "- âŒ **$LANG**: Translation failed" >> translation_summary.md
                FAIL_COUNT=$((FAIL_COUNT + 1))
                
                # Append error to summary
                echo "  \`\`\`" >> translation_summary.md
                tail -n 10 "translation_${LANG}_output.txt" >> translation_summary.md
                echo "  \`\`\`" >> translation_summary.md
              fi
              
              # Clean up output file
              rm -f "translation_${LANG}_output.txt"
            done
          done
          
          # Add summary statistics
          echo "" >> translation_summary.md
          echo "## ðŸ“Š Statistics" >> translation_summary.md
          echo "" >> translation_summary.md
          echo "- **Successful translations:** $SUCCESS_COUNT" >> translation_summary.md
          echo "- **Failed translations:** $FAIL_COUNT" >> translation_summary.md
          echo "- **Total estimated cost:** \$$(printf '%.4f' $TOTAL_COST)" >> translation_summary.md
          
          # Save for PR body
          cat translation_summary.md
          
          # Save outputs for next step
          echo "success_count=$SUCCESS_COUNT" >> $GITHUB_OUTPUT
          echo "fail_count=$FAIL_COUNT" >> $GITHUB_OUTPUT
          echo "total_cost=$TOTAL_COST" >> $GITHUB_OUTPUT
        id: translate
      
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        id: create_pr
        with:
          token: ${{ secrets.TRANSLATION_BOT_TOKEN }}
          commit-message: |
            ðŸŒ Auto-translate: ${{ steps.files.outputs.files }}
            
            Automated translation by Translation Bot
            
            Files: ${{ steps.files.outputs.files }}
            Languages: ${{ steps.files.outputs.languages }}
            Timestamp: ${{ steps.branch.outputs.timestamp }}
          branch: ${{ steps.branch.outputs.branch }}
          delete-branch: true
          title: "ðŸŒ Auto-translate: ${{ github.event_name == 'workflow_dispatch' && 'Manual' || 'Auto' }} (${{ steps.branch.outputs.timestamp }})"
          body: |
            ## ðŸ¤– Automated Translation
            
            This PR contains AI-generated translations using the kobo-translation skill.
            
            ### ðŸ“ Source Files
            
            ```
            ${{ steps.files.outputs.files }}
            ```
            
            ### ðŸŒ Target Languages
            
            ```
            ${{ steps.files.outputs.languages }}
            ```
            
            ### ðŸ“Š Quick Stats
            
            - âœ… Successful: ${{ steps.translate.outputs.success_count }}
            - âŒ Failed: ${{ steps.translate.outputs.fail_count }}
            - ðŸ’° Cost: ~$$${{ steps.translate.outputs.total_cost }}
            
            ---
            
            ### âœ… Translation Quality Checklist
            
            Please verify the following before merging:
            
            **Brand Terminology:**
            - [ ] Server names correct
              - Spanish: "Servidor Global" (NOT "Servidor Global de KoboToolbox")
              - French: "Le serveur KoboToolbox mondial" (WITH "Le")
            - [ ] Question Library has capital article
              - Spanish: "La biblioteca de preguntas"
              - French: "La bibliothÃ¨que de questions"
            - [ ] Formbuilder includes English on first reference
              - Spanish: "editor de formularios de KoboToolbox (Formbuilder)"
              - French: "l'interface de crÃ©ation de formulaires KoboToolbox (KoboToolbox Formbuilder)"
            
            **UI Elements:**
            - [ ] UI terms capitalized correctly (Brouillon/Borrador for Draft)
            - [ ] Button names match UI (DEPLOY â†’ DÃ‰PLOYER/DESPLEGAR)
            - [ ] Tab names in ALL CAPS (FORM â†’ FORMULAIRE/FORMULARIO)
            
            **Language Quality:**
            - [ ] Spanish uses informal "tÃº"
            - [ ] Spanish is gender-inclusive: "los/as usuarios/as"
            - [ ] French uses formal "vous"
            - [ ] French is gender-inclusive: "utilisatrices et utilisateurs"
            
            **Formatting:**
            - [ ] All links preserved and functional
            - [ ] Headers maintained (same level and structure)
            - [ ] Code blocks and formatting intact
            
            ### ðŸ‘¥ Reviewers
            
            Please assign appropriate language reviewers:
            - ðŸ‡ªðŸ‡¸ Spanish: @es-reviewer
            - ðŸ‡«ðŸ‡· French: @fr-reviewer
            - ðŸ‡¸ðŸ‡¦ Arabic: @ar-reviewer
            
            ---
            
            **Triggered by:** ${{ github.event_name == 'workflow_dispatch' && 'Manual workflow' || 'Automatic detection' }}
            **Branch:** `${{ steps.branch.outputs.branch }}`
            **Commit SHA:** ${{ github.sha }}
          labels: |
            translation
            automated
            needs-review
          draft: false
      
      - name: Comment with detailed summary
        if: steps.create_pr.outputs.pull-request-number
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.TRANSLATION_BOT_TOKEN }}
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('translation_summary.md', 'utf8');
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.create_pr.outputs.pull-request-number }},
              body: summary
            });
      
      - name: Job Summary
        if: always()
        run: |
          echo "## ðŸŒ Translation Job Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -n "${{ steps.create_pr.outputs.pull-request-number }}" ]; then
            echo "âœ… **Status:** Pull request created successfully" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ”— **Pull Request:** #${{ steps.create_pr.outputs.pull-request-number }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**URL:** ${{ steps.create_pr.outputs.pull-request-url }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“Š **Statistics:**" >> $GITHUB_STEP_SUMMARY
            echo "- Successful: ${{ steps.translate.outputs.success_count }}" >> $GITHUB_STEP_SUMMARY
            echo "- Failed: ${{ steps.translate.outputs.fail_count }}" >> $GITHUB_STEP_SUMMARY
            echo "- Cost: \$${{ steps.translate.outputs.total_cost }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **Status:** No pull request created" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Possible reasons:" >> $GITHUB_STEP_SUMMARY
            echo "- No changes to commit" >> $GITHUB_STEP_SUMMARY
            echo "- Translations already up to date" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Files Translated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.files.outputs.files }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Languages" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.files.outputs.languages }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY