name: Translate SRT Subtitles

on:
  workflow_dispatch:
    inputs:
      srt_file:
        description: 'Path to SRT file in transcripts/en/ (e.g., intro_tutorial.srt)'
        required: true
        type: string
      languages:
        description: 'Target languages (comma-separated: es, fr, ar, or es,fr,ar for all)'
        required: true
        type: string
        default: 'es,fr,ar'
      video_title:
        description: 'Video title for translation context (optional but recommended)'
        required: false
        type: string
      chunk_size:
        description: 'Subtitles per chunk (default: 25, use 15-20 for long videos, 30-40 for short)'
        required: false
        type: number
        default: 25
      overlap:
        description: 'Overlap between chunks for context (default: 3, use 5-7 for long videos)'
        required: false
        type: number
        default: 3

jobs:
  translate-subtitles:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r scripts/requirements.txt
      
      - name: Validate input file
        run: |
          FILE_PATH="transcripts/en/${{ github.event.inputs.srt_file }}"
          
          if [ ! -f "$FILE_PATH" ]; then
            echo "âŒ Error: File not found: $FILE_PATH"
            echo "Please check the file path and try again."
            exit 1
          fi
          
          echo "âœ… Found source file: $FILE_PATH"
          
          # Validate SRT format
          python scripts/srt_helper.py validate "$FILE_PATH"
      
      - name: Parse languages
        id: parse_langs
        run: |
          LANGS="${{ github.event.inputs.languages }}"
          # Remove spaces and convert to array
          LANGS=$(echo "$LANGS" | tr -d ' ')
          echo "languages=$LANGS" >> $GITHUB_OUTPUT
          echo "ğŸ“‹ Will translate to: $LANGS"
      
      - name: Create output directories
        run: |
          for lang in $(echo "${{ steps.parse_langs.outputs.languages }}" | tr ',' ' '); do
            mkdir -p "transcripts/$lang"
            echo "âœ… Created transcripts/$lang/"
          done
      
      - name: Translate subtitles
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          SOURCE_FILE="transcripts/en/${{ github.event.inputs.srt_file }}"
          FILENAME="${{ github.event.inputs.srt_file }}"
          BASENAME="${FILENAME%.srt}"
          VIDEO_TITLE="${{ github.event.inputs.video_title }}"
          CHUNK_SIZE="${{ github.event.inputs.chunk_size }}"
          OVERLAP="${{ github.event.inputs.overlap }}"
          
          echo "ğŸ¬ Translating: $SOURCE_FILE"
          echo "ğŸ“¦ Chunk size: $CHUNK_SIZE"
          echo "ğŸ”„ Overlap: $OVERLAP"
          
          if [ -n "$VIDEO_TITLE" ]; then
            echo "ğŸ“ Video title: $VIDEO_TITLE"
            TITLE_ARG="--video-title \"$VIDEO_TITLE\""
          else
            echo "â„¹ï¸  No video title provided"
            TITLE_ARG=""
          fi
          
          # Translate to each language
          for lang in $(echo "${{ steps.parse_langs.outputs.languages }}" | tr ',' ' '); do
            echo ""
            echo "================================================"
            echo "Translating to: $lang"
            echo "================================================"
            
            OUTPUT_FILE="transcripts/$lang/${BASENAME}.srt"
            
            if [ -n "$VIDEO_TITLE" ]; then
              python scripts/translate_srt.py "$SOURCE_FILE" \
                --language "$lang" \
                --output "$OUTPUT_FILE" \
                --chunk-size "$CHUNK_SIZE" \
                --overlap "$OVERLAP" \
                --video-title "$VIDEO_TITLE"
            else
              python scripts/translate_srt.py "$SOURCE_FILE" \
                --language "$lang" \
                --output "$OUTPUT_FILE" \
                --chunk-size "$CHUNK_SIZE" \
                --overlap "$OVERLAP"
            fi
            
            if [ $? -eq 0 ]; then
              echo "âœ… Translation complete: $OUTPUT_FILE"
              
              # Validate output
              python scripts/srt_helper.py validate "$OUTPUT_FILE"
            else
              echo "âŒ Translation failed for language: $lang"
              exit 1
            fi
          done
      
      - name: Generate summary
        if: always()
        run: |
          echo "## ğŸ“Š Translation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Source File:** \`transcripts/en/${{ github.event.inputs.srt_file }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Languages:** ${{ github.event.inputs.languages }}" >> $GITHUB_STEP_SUMMARY
          
          if [ -n "${{ github.event.inputs.video_title }}" ]; then
            echo "**Video Title:** ${{ github.event.inputs.video_title }}" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "**Chunk Size:** ${{ github.event.inputs.chunk_size }}" >> $GITHUB_STEP_SUMMARY
          echo "**Overlap:** ${{ github.event.inputs.overlap }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“ Generated Files" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          BASENAME="${{ github.event.inputs.srt_file }}"
          BASENAME="${BASENAME%.srt}"
          
          for lang in $(echo "${{ steps.parse_langs.outputs.languages }}" | tr ',' ' '); do
            OUTPUT_FILE="transcripts/$lang/${BASENAME}.srt"
            if [ -f "$OUTPUT_FILE" ]; then
              SUBTITLE_COUNT=$(grep -c "^[0-9]\+$" "$OUTPUT_FILE" || echo "0")
              FILE_SIZE=$(du -h "$OUTPUT_FILE" | cut -f1)
              echo "- âœ… \`$OUTPUT_FILE\` ($SUBTITLE_COUNT subtitles, $FILE_SIZE)" >> $GITHUB_STEP_SUMMARY
            else
              echo "- âŒ \`$OUTPUT_FILE\` (failed)" >> $GITHUB_STEP_SUMMARY
            fi
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. Download the artifacts below to review translations" >> $GITHUB_STEP_SUMMARY
          echo "2. Check subtitle quality (brand terms, character limits, etc.)" >> $GITHUB_STEP_SUMMARY
          echo "3. If satisfied, commit the translations to the repository" >> $GITHUB_STEP_SUMMARY
          echo "4. Upload SRT files to your video platform" >> $GITHUB_STEP_SUMMARY
      
      - name: Upload translated subtitles as artifact
        uses: actions/upload-artifact@v4
        with:
          name: translated-subtitles
          path: |
            transcripts/*/
            !transcripts/en/
          retention-days: 30
      
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.TRANSLATION_BOT_TOKEN }}
          commit-message: |
            Translate subtitles: ${{ github.event.inputs.srt_file }}
            
            - Source: transcripts/en/${{ github.event.inputs.srt_file }}
            - Languages: ${{ github.event.inputs.languages }}
            - Video: ${{ github.event.inputs.video_title }}
            - Chunk size: ${{ github.event.inputs.chunk_size }}
            - Overlap: ${{ github.event.inputs.overlap }}
          branch: translate-srt-${{ github.run_number }}
          delete-branch: true
          title: 'ğŸ¬ Translate subtitles: ${{ github.event.inputs.srt_file }}'
          body: |
            ## ğŸ¬ SRT Subtitle Translation
            
            **Source File:** `transcripts/en/${{ github.event.inputs.srt_file }}`
            
            **Target Languages:** ${{ github.event.inputs.languages }}
            
            **Video Title:** ${{ github.event.inputs.video_title || '(not provided)' }}
            
            ### âš™ï¸ Translation Parameters
            
            - **Chunk size:** ${{ github.event.inputs.chunk_size }} subtitles
            - **Overlap:** ${{ github.event.inputs.overlap }} subtitles
            
            ### ğŸ“ Review Checklist
            
            Before merging, please verify:
            
            **Brand Terms:**
            - [ ] Server names correct (Servidor Global, Le serveur KoboToolbox mondial)
            - [ ] Question Library has capital L (La biblioteca de preguntas, La bibliothÃ¨que de questions)
            - [ ] Formbuilder translated appropriately for context
            - [ ] All UI elements match official translations
            
            **Technical Terms:**
            - [ ] XLSForm terms in English only (list_name, cascading select, etc.)
            - [ ] No parenthetical translations added
            
            **Subtitle Quality:**
            - [ ] All lines under 50 characters per line
            - [ ] Natural spoken language (not overly formal)
            - [ ] Character limits respected
            - [ ] Timing and subtitle count unchanged
            
            **Language Specific:**
            - [ ] Spanish: Informal tÃº, gender-inclusive (los/as usuarios/as)
            - [ ] French: Formal vous, gender markers (utilisatrices et utilisateurs)
            - [ ] Arabic: RTL considerations if applicable
            
            ### ğŸ§ª Validation
            
            All translated files have been automatically validated for:
            - âœ… Proper SRT format
            - âœ… Sequential numbering
            - âœ… Valid timestamps
            - âœ… No overlaps
            
            ### ğŸ“Š Files Changed
            
            See the Files Changed tab to review the actual translations.
            
            ### ğŸ’¡ Next Steps
            
            1. Review the translations in the Files Changed tab
            2. Check the quality checklist above
            3. If approved, merge this PR
            4. Download the SRT files and upload to your video platform
            
            ---
            
            ğŸ¤– *This PR was automatically created by the [Translate SRT Subtitles workflow](https://github.com/${{ github.repository }}/actions/workflows/translate-srt.yml)*
          labels: |
            translation
            subtitles
            automated
          assignees: ${{ github.actor }}
