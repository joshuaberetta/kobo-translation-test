name: Auto-Translate Documentation

on:
  push:
    branches:
      - main
    paths:
      - 'docs/en/**'
  
  workflow_dispatch:
    inputs:
      files_to_translate:
        description: 'Files to translate (comma-separated, e.g., docs/en/test_simple.md)'
        required: false
        default: 'docs/en/test_simple.md'
      languages:
        description: 'Languages (comma-separated: es,fr,ar)'
        required: false
        default: 'es,fr,ar'

jobs:
  translate-and-pr:
    name: Translate & Create PR
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.TRANSLATION_BOT_TOKEN }}
          fetch-depth: 2  # Fetch enough history for diff detection (0 = all history, can be slow)
      
      - name: Detect changed files
        id: detect
        run: |
          echo "Event: ${{ github.event_name }}"
          
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            # Manual trigger - use input
            FILES="${{ github.event.inputs.files_to_translate }}"
            LANGUAGES="${{ github.event.inputs.languages }}"
            echo "Manual trigger - using input files"
          else
            # Auto trigger - detect what changed
            echo "Auto trigger - detecting changes..."
            echo "github.event.before: ${{ github.event.before }}"
            echo "github.sha: ${{ github.sha }}"
            
            # Try different methods to detect changes
            if [ -n "${{ github.event.before }}" ] && [ "${{ github.event.before }}" != "0000000000000000000000000000000000000000" ]; then
              echo "Method 1: Using github.event.before..."
              CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} -- 'docs/en/*.md' 'docs/en/**/*.md' || echo "")
            else
              echo "Method 1 skipped: github.event.before not available"
              CHANGED_FILES=""
            fi
            
            # If that doesn't work, try HEAD~1
            if [ -z "$CHANGED_FILES" ]; then
              echo "Method 2: Using HEAD~1..."
              CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD -- 'docs/en/*.md' 'docs/en/**/*.md' 2>/dev/null || echo "")
            fi
            
            # If still nothing, try comparing with origin/main
            if [ -z "$CHANGED_FILES" ]; then
              echo "Method 3: Using origin/main..."
              git fetch origin main 2>/dev/null || true
              CHANGED_FILES=$(git diff --name-only origin/main HEAD -- 'docs/en/*.md' 'docs/en/**/*.md' 2>/dev/null || echo "")
            fi
            
            # If still nothing, check if this is the first commit or get recently modified files
            if [ -z "$CHANGED_FILES" ]; then
              echo "Method 4: Listing all docs/en files from latest commit..."
              CHANGED_FILES=$(git diff-tree --no-commit-id --name-only -r HEAD -- 'docs/en/*.md' 'docs/en/**/*.md' 2>/dev/null || echo "")
            fi
            
            echo "Changed files found:"
            echo "$CHANGED_FILES"
            
            # Convert newlines to commas
            FILES=$(echo "$CHANGED_FILES" | tr '\n' ',' | sed 's/,$//' | sed 's/^,//')
            LANGUAGES="es,fr,ar"
          fi
          
          echo "files=$FILES" >> $GITHUB_OUTPUT
          echo "languages=$LANGUAGES" >> $GITHUB_OUTPUT
          
          echo "=== Detection Results ==="
          echo "Files to translate: $FILES"
          echo "Languages: $LANGUAGES"
          
          # Check if we have files
          if [ -z "$FILES" ] || [ "$FILES" == "" ]; then
            echo "has_files=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è No files detected for translation"
          else
            echo "has_files=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Files detected: $FILES"
          fi
      
      - name: Debug - Show git info
        if: steps.detect.outputs.has_files == 'false'
        run: |
          echo "=== Debug Information ==="
          echo "Current commit: ${{ github.sha }}"
          echo "Previous commit: ${{ github.event.before }}"
          echo ""
          echo "All files in docs/en/:"
          find docs/en -name "*.md" -type f || echo "No files found"
          echo ""
          echo "Git log (last 3 commits):"
          git log --oneline -3 --name-only
          echo ""
          echo "Git diff HEAD~1:"
          git diff --name-only HEAD~1 HEAD || echo "No diff available"
      
      - name: Stop if no files
        if: steps.detect.outputs.has_files == 'false'
        run: |
          echo "‚ÑπÔ∏è No markdown files in docs/en/ were changed in this commit."
          echo "This is normal if you only updated workflow files or other non-doc files."
          echo ""
          echo "To translate files manually, use the 'Run workflow' button and specify files."
          exit 0
      
      - name: Set up Python
        if: steps.detect.outputs.has_files == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        if: steps.detect.outputs.has_files == 'true'
        run: |
          pip install -r scripts/requirements.txt
      
      - name: Verify skill files
        if: steps.detect.outputs.has_files == 'true'
        run: |
          echo "üìö Checking for skill files..."
          if [ ! -d "skills/kobo-translation" ]; then
            echo "‚ùå Error: skills/kobo-translation directory not found"
            exit 1
          fi
          
          if [ ! -f "skills/kobo-translation/SKILL.md" ]; then
            echo "‚ùå Error: SKILL.md not found"
            exit 1
          fi
          
          echo "‚úÖ Skill files found"
      
      - name: Translate documents
        if: steps.detect.outputs.has_files == 'true'
        id: translate
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "ü§ñ Starting translation process..."
          
          FILES="${{ steps.detect.outputs.files }}"
          LANGUAGES="${{ steps.detect.outputs.languages }}"
          
          echo "Files: $FILES"
          echo "Languages: $LANGUAGES"
          
          # Convert comma-separated to arrays
          IFS=',' read -ra FILE_ARRAY <<< "$FILES"
          IFS=',' read -ra LANG_ARRAY <<< "$LANGUAGES"
          
          TOTAL_COST=0
          SUCCESS_COUNT=0
          FAIL_COUNT=0
          
          # Create summary
          echo "# Translation Summary" > translation_summary.md
          echo "" >> translation_summary.md
          echo "**Timestamp:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> translation_summary.md
          echo "" >> translation_summary.md
          
          # Translate each file to each language
          for FILE in "${FILE_ARRAY[@]}"; do
            # Skip empty entries
            if [ -z "$FILE" ] || [ "$FILE" == " " ]; then
              continue
            fi
            
            echo "" >> translation_summary.md
            echo "## üìÑ \`$(basename "$FILE")\`" >> translation_summary.md
            echo "" >> translation_summary.md
            
            # Check if this is a new file or an update
            FILENAME=$(basename "$FILE")
            IS_NEW_FILE=true
            
            for LANG in "${LANG_ARRAY[@]}"; do
              # Skip empty entries
              if [ -z "$LANG" ] || [ "$LANG" == " " ]; then
                continue
              fi
              
              TARGET_FILE="docs/$LANG/$FILENAME"
              
              # Check if file has manual edit marker
              if [ -f "$TARGET_FILE" ] && grep -q "<!-- MANUAL_EDIT: DO NOT AUTO-TRANSLATE -->" "$TARGET_FILE"; then
                echo "  ‚è≠Ô∏è  $LANG: SKIPPED (manual edits detected)"
                echo "- ‚è≠Ô∏è  **$LANG**: Skipped - file contains manual edits marker" >> translation_summary.md
                echo "  " >> translation_summary.md
                echo "  To allow auto-translation, remove the \`<!-- MANUAL_EDIT: DO NOT AUTO-TRANSLATE -->\` comment" >> translation_summary.md
                continue
              fi
              
              # Check if this is a new file or update
              if [ ! -f "$TARGET_FILE" ]; then
                # NEW FILE - full translation
                echo "  üÜï NEW FILE: Full translation to $LANG..."
                echo "- üìä **$LANG**: Full translation (new file)" >> translation_summary.md
                
                if python scripts/translation_agent.py \
                  --file "$FILE" \
                  --language "$LANG" \
                  --save \
                  --test > "translation_${LANG}.log" 2>&1; then
                  
                  echo "  ‚úÖ $LANG: Success"
                  echo "  ‚úÖ Translation completed" >> translation_summary.md
                  SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
                  
                  # Extract cost
                  if grep -q "Estimated cost" "translation_${LANG}.log"; then
                    COST=$(grep "Estimated cost" "translation_${LANG}.log" | grep -oP '\$\K[0-9.]+' || echo "0")
                    TOTAL_COST=$(echo "$TOTAL_COST + $COST" | bc -l)
                    echo "  üí∞ Cost: \$$COST" >> translation_summary.md
                  fi
                else
                  echo "  ‚ùå $LANG: Failed"
                  echo "  ‚ùå Failed" >> translation_summary.md
                  FAIL_COUNT=$((FAIL_COUNT + 1))
                  
                  echo "  <details><summary>Error log</summary>" >> translation_summary.md
                  echo "  " >> translation_summary.md
                  echo '  ```' >> translation_summary.md
                  tail -n 20 "translation_${LANG}.log" >> translation_summary.md
                  echo '  ```' >> translation_summary.md
                  echo "  </details>" >> translation_summary.md
                fi
                
                rm -f "translation_${LANG}.log"
              else
                # EXISTING FILE - extract and translate only the English diff
                echo "  ÔøΩ UPDATE: Extracting changes for $LANG..."
                echo "- üìä **$LANG**: Diff-based update" >> translation_summary.md
                
                # Get the actual changes from English source
                if [ -n "${{ github.event.before }}" ] && [ "${{ github.event.before }}" != "0000000000000000000000000000000000000000" ]; then
                  ENGLISH_DIFF=$(git diff -U0 ${{ github.event.before }} ${{ github.sha }} -- "$FILE" 2>/dev/null || echo "")
                else
                  ENGLISH_DIFF=$(git diff -U0 HEAD~1 HEAD -- "$FILE" 2>/dev/null || echo "")
                fi
                
                if [ -z "$ENGLISH_DIFF" ]; then
                  echo "  ‚ÑπÔ∏è  No changes detected in English source - skipping"
                  echo "  ‚ÑπÔ∏è  No changes in source" >> translation_summary.md
                  continue
                fi
                
                # Extract only added lines (new content to translate)
                NEW_CONTENT=$(echo "$ENGLISH_DIFF" | grep -E '^\+[^+]' | sed 's/^+//' || echo "")
                
                # Extract removed lines (old content)
                OLD_CONTENT=$(echo "$ENGLISH_DIFF" | grep -E '^\-[^-]' | sed 's/^-//' || echo "")
                
                if [ -z "$NEW_CONTENT" ]; then
                  echo "  ‚ÑπÔ∏è  Only deletions detected - skipping"
                  echo "  ‚ÑπÔ∏è  Only deletions (no translation needed)" >> translation_summary.md
                  continue
                fi
                
                echo "  üîç Found: ${#NEW_CONTENT} chars of new/modified content"
                echo "  üìù ${#NEW_CONTENT} chars to translate" >> translation_summary.md
                
                # Save content to temp files for Python script
                echo "$NEW_CONTENT" > "/tmp/new_content_${LANG}.txt"
                echo "$OLD_CONTENT" > "/tmp/old_content_${LANG}.txt"
                
                # Translate only the diff using update mode
                if python scripts/translation_agent.py \
                  --file "$FILE" \
                  --language "$LANG" \
                  --update-mode \
                  --diff "$NEW_CONTENT" \
                  --test > "translation_${LANG}.log" 2>&1; then
                  
                  # Extract translated content using helper script
                  TRANSLATED_CONTENT=$(python3 scripts/extract_translation.py "translation_${LANG}.log" 2>/dev/null || echo "")
                  
                  if [ -n "$TRANSLATED_CONTENT" ]; then
                    echo "$TRANSLATED_CONTENT" > "/tmp/translated_${LANG}.txt"
                    
                    # Apply the translated diff to existing file using helper script
                    if python3 scripts/apply_diff_translation.py \
                      --target "$TARGET_FILE" \
                      --old "$OLD_CONTENT" \
                      --new "$TRANSLATED_CONTENT" \
                      --mode smart; then
                      
                      echo "  ‚úÖ $LANG: Diff applied successfully"
                      echo "  ‚úÖ Diff translated and applied" >> translation_summary.md
                      SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
                    else
                      echo "  ‚ùå $LANG: Failed to apply diff"
                      echo "  ‚ùå Failed to apply diff" >> translation_summary.md
                      FAIL_COUNT=$((FAIL_COUNT + 1))
                    fi
                  else
                    echo "  ‚ùå $LANG: No translated content extracted"
                    echo "  ‚ùå No translation output" >> translation_summary.md
                    FAIL_COUNT=$((FAIL_COUNT + 1))
                  fi
                  
                  # Extract cost
                  if grep -q "Estimated cost" "translation_${LANG}.log"; then
                    COST=$(grep "Estimated cost" "translation_${LANG}.log" | grep -oP '\$\K[0-9.]+' || echo "0")
                    TOTAL_COST=$(echo "$TOTAL_COST + $COST" | bc -l)
                    echo "  üí∞ Cost: \$$COST" >> translation_summary.md
                  fi
                else
                  echo "  ‚ùå $LANG: Translation failed"
                  echo "  ‚ùå Translation failed" >> translation_summary.md
                  FAIL_COUNT=$((FAIL_COUNT + 1))
                  
                  echo "  <details><summary>Error log</summary>" >> translation_summary.md
                  echo "  " >> translation_summary.md
                  echo '  ```' >> translation_summary.md
                  tail -n 20 "translation_${LANG}.log" >> translation_summary.md
                  echo '  ```' >> translation_summary.md
                  echo "  </details>" >> translation_summary.md
                fi
                
                # Cleanup temp files
                rm -f "/tmp/new_content_${LANG}.txt" "/tmp/old_content_${LANG}.txt" "/tmp/translated_${LANG}.txt" "translation_${LANG}.log"
              fi
            done
          done
          
          # Add statistics
          echo "" >> translation_summary.md
          echo "## üìä Statistics" >> translation_summary.md
          echo "" >> translation_summary.md
          echo "- ‚úÖ Successful: $SUCCESS_COUNT" >> translation_summary.md
          echo "- ‚ùå Failed: $FAIL_COUNT" >> translation_summary.md
          echo "- üí∞ Total cost: \$$(printf '%.4f' $TOTAL_COST)" >> translation_summary.md
          
          cat translation_summary.md
          
          # Save outputs
          echo "success_count=$SUCCESS_COUNT" >> $GITHUB_OUTPUT
          echo "fail_count=$FAIL_COUNT" >> $GITHUB_OUTPUT
          echo "total_cost=$(printf '%.4f' $TOTAL_COST)" >> $GITHUB_OUTPUT
      
      - name: Create Pull Request
        if: steps.detect.outputs.has_files == 'true'
        uses: peter-evans/create-pull-request@v6
        id: pr
        with:
          token: ${{ secrets.TRANSLATION_BOT_TOKEN }}
          commit-message: |
            üåê Auto-translate: Update translations
            
            Files: ${{ steps.detect.outputs.files }}
            Languages: ${{ steps.detect.outputs.languages }}
            
            Automated by Translation Bot
          branch: translations/auto-${{ github.run_number }}
          delete-branch: true
          title: "üåê Auto-translate #${{ github.run_number }}"
          body: |
            ## ü§ñ Automated Translation
            
            AI-generated translations using the kobo-translation skill with **diff-based updates**.
            
            ### üîÑ Translation Mode
            
            - **New files**: Full translation
            - **Existing files**: Only changed content translated and merged
            
            This preserves manual reviewer improvements in unchanged sections.
            
            **‚ö†Ô∏è IMPORTANT: Protecting Manual Edits**
            
            To protect entire files from auto-translation:
            
            1. Add this comment at the top of the translation file:
               ```html
               <!-- MANUAL_EDIT: DO NOT AUTO-TRANSLATE -->
               ```
            
            2. Files with this marker will be completely skipped
            
            3. To update protected files, remove the marker temporarily or update manually
            
            **Files are NOT protected by default**. The diff-based system already preserves unchanged sections automatically.
            
            ---
            
            ### üìù Source Files
            
            ```
            ${{ steps.detect.outputs.files }}
            ```
            
            ### üåê Languages
            
            ```
            ${{ steps.detect.outputs.languages }}
            ```
            
            ### üìä Results
            
            - ‚úÖ Successful: ${{ steps.translate.outputs.success_count }}
            - ‚ùå Failed: ${{ steps.translate.outputs.fail_count }}
            - üí∞ Cost: ~$$${{ steps.translate.outputs.total_cost }}
            
            ---
            
            ### ‚úÖ Review Checklist
            
            **Brand Terms:**
            - [ ] Spanish: "Servidor Global" (NOT "de KoboToolbox")
            - [ ] French: "Le serveur KoboToolbox mondial" (WITH "Le")
            - [ ] Spanish: "La biblioteca de preguntas" (capital L)
            - [ ] French: "La biblioth√®que de questions" (capital L)
            - [ ] Formbuilder: English in parentheses on first reference
            
            **UI Elements:**
            - [ ] Draft ‚Üí Brouillon (FR) / Borrador (ES) - capitalized
            - [ ] Tabs: FORMULAIRE / FORMULARIO (all caps)
            - [ ] Buttons match UI translations
            
            **Language Quality:**
            - [ ] Spanish: informal "t√∫" + gender-inclusive "los/as"
            - [ ] French: formal "vous" + "utilisatrices et utilisateurs"
            - [ ] Links and formatting preserved
            
            **Reviewers:** @es-reviewer @fr-reviewer @ar-reviewer
            
            ---
            
            Run: #${{ github.run_number }} | Commit: ${{ github.sha }}
          labels: |
            translation
            automated
            needs-review
      
      - name: Comment with summary
        if: steps.pr.outputs.pull-request-number
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.TRANSLATION_BOT_TOKEN }}
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('translation_summary.md', 'utf8');
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.pr.outputs.pull-request-number }},
              body: summary
            });
      
      - name: Job summary
        if: always()
        run: |
          echo "## üåê Translation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -n "${{ steps.pr.outputs.pull-request-number }}" ]; then
            echo "‚úÖ **Pull Request Created**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- PR #${{ steps.pr.outputs.pull-request-number }}" >> $GITHUB_STEP_SUMMARY
            echo "- URL: ${{ steps.pr.outputs.pull-request-url }}" >> $GITHUB_STEP_SUMMARY
            echo "- Successful: ${{ steps.translate.outputs.success_count }}" >> $GITHUB_STEP_SUMMARY
            echo "- Failed: ${{ steps.translate.outputs.fail_count }}" >> $GITHUB_STEP_SUMMARY
            echo "- Cost: \$${{ steps.translate.outputs.total_cost }}" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.detect.outputs.has_files }}" == "false" ]; then
            echo "‚ÑπÔ∏è **No files to translate**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "No markdown files in docs/en/ were changed in this commit." >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è **No PR created**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Check logs for errors." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Detected Files" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.detect.outputs.files }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY